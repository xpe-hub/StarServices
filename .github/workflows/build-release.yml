name: Build and Release StarServices

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:

jobs:
  build:
    name: Compile StarServices.exe
    runs-on: windows-latest
    permissions:
      contents: read
      attestations: write
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check for existing GCC
        run: |
          Write-Host "Checking for existing GCC..." -ForegroundColor Cyan
          $gccPath = (Get-Command gcc -ErrorAction SilentlyContinue)
          if ($gccPath) {
              Write-Host "GCC found at: $($gccPath.Source)" -ForegroundColor Green
              gcc --version
          } else {
              Write-Host "GCC not found, attempting to install..." -ForegroundColor Yellow
              
              # Try chocolatey as fallback
              choco install mingw -y --version 13.2.0
              refreshenv
              
              # Add to PATH
              $env:PATH = "C:\ProgramData\Chocolatey\lib\mingw\tools\mingw64\bin;$env:PATH"
              echo "C:\ProgramData\Chocolatey\lib\mingw\tools\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          }

      - name: Verify GCC Installation
        run: |
          gcc --version
          Write-Host "GCC installed successfully!" -ForegroundColor Green

      - name: Compile StarServices
        run: |
          Write-Host "Compiling StarServices.c..." -ForegroundColor Cyan
          gcc -v -o StarServices.exe StarServices.c -ladvapi32 -lkernel32 2>&1 | Out-String
          if ($LASTEXITCODE -eq 0) {
              Write-Host "Compilation complete!" -ForegroundColor Green
          } else {
              Write-Host "Compilation failed!" -ForegroundColor Red
              exit 1
          }

      - name: Verify Executable
        shell: powershell
        run: |
          Write-Host "=== Verifying StarServices.exe ===" -ForegroundColor Cyan
          
          if (Test-Path "StarServices.exe") {
              Write-Host "[OK] StarServices.exe created successfully" -ForegroundColor Green
              
              $file = Get-Item "StarServices.exe"
              Write-Host "File size: $($file.Length / 1KB) KB" -ForegroundColor Yellow
              
              # Read enough bytes to get PE header info (at least 128 bytes)
              $bytes = Get-Content "StarServices.exe" -Encoding Byte -ReadCount 128 -TotalCount 128
              
              # Check PE header (MZ = 4D 5A)
              $hex = [System.BitConverter]::ToString($bytes[0..1])
              
              if ($hex -eq "4D-5A") {
                  Write-Host "[OK] Valid PE header detected (MZ)" -ForegroundColor Green
              } else {
                  Write-Host "[ERROR] Invalid file format" -ForegroundColor Red
                  exit 1
              }
              
              # Read PE offset from bytes 60-63
              $peOffset = [System.BitConverter]::ToInt32($bytes[60..63], 0)
              Write-Host "PE offset: $peOffset" -ForegroundColor Yellow
              
              # Read machine type from PE header + 4
              if ($peOffset + 4 -lt $bytes.Length) {
                  $machineBytes = $bytes[($peOffset + 4)..($peOffset + 5)]
                  $machineType = [System.BitConverter]::ToInt16($machineBytes, 0)
                  
                  if ($machineType -eq 8664) {
                      Write-Host "[OK] 64-bit executable (x86-64)" -ForegroundColor Green
                  } elseif ($machineType -eq 332) {
                      Write-Host "[OK] 32-bit executable (x86)" -ForegroundColor Yellow
                  } else {
                      Write-Host "[?] Unknown architecture (machine type: $machineType)" -ForegroundColor Yellow
                  }
              } else {
                  Write-Host "[?] Could not determine architecture" -ForegroundColor Yellow
              }
              
          } else {
              Write-Host "[ERROR] StarServices.exe not found!" -ForegroundColor Red
              exit 1
          }
          
          Write-Host "=== Verification Complete ===" -ForegroundColor Cyan

      - name: Generate Attestation
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: 'StarServices.exe'

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: StarServices-Windows
          path: StarServices.exe
          retention-days: 7

  release:
    name: Create Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: StarServices-Windows
          path: release

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/StarServices.exe
          generate_release_notes: true
          draft: false
          prerelease: false
          name: StarServices Release
          body: |
            ## StarServices - Tournament Anti-Cheat Service Manager
            
            Automated Windows executable compilation.
            
            ### Files
            - StarServices.exe
            
            ### Build Info
            - Compiled from: ${{ github.sha }}
            - Runner: Windows Latest
            - Compiler: MinGW-w64 GCC
            
            ### Usage
            1. Download StarServices.exe
            2. Right-click > Run as administrator
            3. The tool will activate all required services automatically
            
            Copyright (c) 2025-2030 xpe.nettt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List Release Assets
        run: |
          echo "=== Release Created Successfully ==="
          gh release view --json assets -q '.assets[].name' || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
